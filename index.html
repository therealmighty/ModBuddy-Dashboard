<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ModBuddy Dashboard</title>
  <link
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    rel="stylesheet"
  />
  <style>
    /* Loading spinner */
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: #3b82f6;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">
  <div class="max-w-5xl mx-auto p-6">
    <header class="flex items-center justify-between mb-8">
      <h1 class="text-4xl font-extrabold tracking-tight">ModBuddy Dashboard</h1>
      <button
        id="logoutBtn"
        class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded shadow-md hidden transition-colors duration-200"
        aria-label="Logout"
      >
        Logout
      </button>
    </header>

    <section id="authSection" class="mb-8 text-center">
      <a
        href="https://discord.com/api/oauth2/authorize?client_id=1389678002287411351&redirect_uri=https%3A%2F%2Ftherealmighty.github.io%2FModBuddy-Dashboard%2F&response_type=token&scope=identify%20guilds"
        class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded shadow-lg transition-colors duration-200"
      >
        Login with Discord
      </a>
    </section>

    <section id="dashboard" class="hidden space-y-10">
      <div>
        <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">
          Your Servers with Bot
        </h2>

        <div id="loadingGuilds" class="spinner"></div>
        <div id="guildError" class="hidden text-red-500 font-semibold text-center mb-4"></div>

        <div
          id="guildList"
          class="grid grid-cols-1 sm:grid-cols-2 gap-6 max-h-96 overflow-y-auto"
          tabindex="0"
          aria-label="List of user guilds with bot"
        ></div>

        <div
          id="noGuilds"
          class="hidden mt-6 text-center text-gray-400 text-lg"
        >
          No servers found.<br />
          <a
            id="inviteLink"
            href="#"
            class="text-blue-400 underline hover:text-blue-600"
            target="_blank"
            rel="noopener noreferrer"
          >
            Add bot to your server?
          </a>
        </div>
      </div>

      <div id="guildDetails" class="hidden bg-gray-800 rounded-lg shadow-lg p-6">
        <h3 class="text-3xl font-bold mb-4">
          Server Dashboard: <span id="serverName"></span>
        </h3>

        <div class="mb-6">
          <h4 class="text-xl font-semibold mb-2 flex items-center">
            ‚öôÔ∏è Settings
          </h4>
          <label class="flex items-center space-x-3 cursor-pointer text-lg">
            <input type="checkbox" id="slurFilter" class="w-5 h-5 rounded" />
            <span>Racial Slur Filter</span>
          </label>
        </div>

        <div class="mb-6">
          <h4 class="text-xl font-semibold mb-2 flex items-center">
            üìã Moderation Logs
          </h4>
          <ul
            id="modLogs"
            class="list-disc pl-6 max-h-48 overflow-y-auto text-sm space-y-1 font-mono bg-gray-900 rounded p-3 shadow-inner"
          ></ul>
        </div>

        <div>
          <h4 class="text-xl font-semibold mb-2 flex items-center">
            üë• Manage Moderators
          </h4>

          <ul
            id="modList"
            class="text-sm mb-4 space-y-1"
            aria-label="Current moderators"
          ></ul>

          <input
            id="modUserId"
            type="text"
            placeholder="User ID to add/remove"
            class="w-full max-w-xs px-3 py-2 rounded text-black focus:outline-none focus:ring-2 focus:ring-blue-500"
            aria-label="User ID input"
          />

          <div class="space-x-3 mt-3">
            <button
              id="addModBtn"
              class="bg-green-600 hover:bg-green-700 px-5 py-2 rounded shadow disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
              disabled
            >
              Add
            </button>
            <button
              id="removeModBtn"
              class="bg-red-600 hover:bg-red-700 px-5 py-2 rounded shadow disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
              disabled
            >
              Remove
            </button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const apiBase = "http://localhost:3001/api"; // Change to your actual API endpoint
    const botInviteURL =
      "https://discord.com/oauth2/authorize?client_id=1389678002287411351&scope=bot%20applications.commands&permissions=268823616";

    let accessToken = null;
    let currentGuild = null;
    let moderators = [];

    // Helpers
    function hasManageGuild(permissions, owner) {
      return owner || (permissions & 0x20) === 0x20;
    }

    // UI Elements
    const authSection = document.getElementById("authSection");
    const dashboard = document.getElementById("dashboard");
    const logoutBtn = document.getElementById("logoutBtn");
    const guildList = document.getElementById("guildList");
    const noGuilds = document.getElementById("noGuilds");
    const inviteLink = document.getElementById("inviteLink");
    const loadingGuilds = document.getElementById("loadingGuilds");
    const guildError = document.getElementById("guildError");
    const guildDetails = document.getElementById("guildDetails");
    const serverNameElem = document.getElementById("serverName");
    const slurFilterToggle = document.getElementById("slurFilter");
    const modLogs = document.getElementById("modLogs");
    const modList = document.getElementById("modList");
    const modUserIdInput = document.getElementById("modUserId");
    const addBtn = document.getElementById("addModBtn");
    const removeBtn = document.getElementById("removeModBtn");

    // Fetch user guilds
    async function fetchUserGuilds() {
      const res = await fetch("https://discord.com/api/users/@me/guilds", {
        headers: { Authorization: `Bearer ${accessToken}` },
      });
      if (!res.ok) throw new Error("Failed to fetch user guilds");
      return await res.json();
    }

    // Fetch bot guilds from backend
    async function fetchBotGuilds() {
      const res = await fetch(`${apiBase}/bot/guilds`);
      if (!res.ok) throw new Error("Failed to fetch bot guilds");
      return await res.json();
    }

    // Render guild cards
    function renderGuilds(userGuilds, botGuildIds) {
      guildList.innerHTML = "";
      guildError.classList.add("hidden");
      noGuilds.classList.add("hidden");

      const filteredGuilds = userGuilds.filter(
        (g) => hasManageGuild(g.permissions, g.owner) && botGuildIds.includes(g.id)
      );

      loadingGuilds.style.display = "none";

      if (filteredGuilds.length === 0) {
        noGuilds.classList.remove("hidden");
        inviteLink.href = botInviteURL;
        return;
      }

      filteredGuilds.forEach((g) => {
        const card = document.createElement("button");
        card.className =
          "bg-gray-800 rounded-lg p-5 shadow-md hover:bg-gray-700 transition-colors w-full text-left focus:outline-none focus:ring-2 focus:ring-blue-500";
        card.innerHTML = `
          <h3 class="text-xl font-semibold mb-1">${g.name}</h3>
          <p class="text-sm text-gray-400">ID: ${g.id}</p>
        `;
        card.onclick = () => loadGuildDashboard(g);
        guildList.appendChild(card);
      });
    }

    // Load guild dashboard details
    async function loadGuildDashboard(guild) {
      currentGuild = guild;
      guildDetails.classList.remove("hidden");
      serverNameElem.textContent = guild.name;

      try {
        const [logs, settings, mods] = await Promise.all([
          fetch(`${apiBase}/${guild.id}/logs`).then((r) => {
            if (!r.ok) throw new Error("Failed to fetch logs");
            return r.json();
          }),
          fetch(`${apiBase}/${guild.id}/settings`).then((r) => {
            if (!r.ok) throw new Error("Failed to fetch settings");
            return r.json();
          }),
          fetch(`${apiBase}/${guild.id}/moderators`).then((r) => {
            if (!r.ok) throw new Error("Failed to fetch moderators");
            return r.json();
          }),
        ]);

        moderators = mods || [];

        slurFilterToggle.checked = settings.racialFilter || false;

        // Populate mod logs
        modLogs.innerHTML = "";
        logs.forEach((log) => {
          const li = document.createElement("li");
          li.textContent = `${log.timestamp}: ${log.action} ${log.user} - ${log.reason}`;
          modLogs.appendChild(li);
        });

        // Populate moderators list
        modList.innerHTML = "";
        moderators.forEach((modId) => {
          const li = document.createElement("li");
          li.textContent = `User ID: ${modId}`;
          modList.appendChild(li);
        });

        updateButtonsState();
      } catch (e) {
        alert("Failed to load guild details.");
        console.error(e);
      }
    }

    // Update add/remove buttons enabled state
    function updateButtonsState() {
      const val = modUserIdInput.value.trim();
      const valid = val.length > 0;
      addBtn.disabled = !valid;
      removeBtn.disabled = !valid;
    }

    // Logout function
    function logout() {
      localStorage.removeItem("discord_access_token");
      accessToken = null;
      currentGuild = null;
      moderators = [];

      authSection.classList.remove("hidden");
      dashboard.classList.add("hidden");
      guildList.innerHTML = "";
      guildDetails.classList.add("hidden");
      logoutBtn.classList.add("hidden");
      loadingGuilds.style.display = "none";
      guildError.classList.add("hidden");
      noGuilds.classList.add("hidden");
    }

    // Initialize dashboard on page load
    window.onload = async () => {
      // Handle token in URL hash and localStorage
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      let tokenFromUrl = params.get("access_token");

      if (tokenFromUrl) {
        localStorage.setItem("discord_access_token", tokenFromUrl);
        history.replaceState(null, null, window.location.pathname + window.location.search);
      }

      accessToken = tokenFromUrl || localStorage.getItem("discord_access_token");

      if (accessToken) {
        authSection.classList.add("hidden");
        dashboard.classList.remove("hidden");
        logoutBtn.classList.remove("hidden");
        loadingGuilds.style.display = "block";

        try {
          const [userGuilds, botGuildIds] = await Promise.all([
            fetchUserGuilds(),
            fetchBotGuilds(),
          ]);
          renderGuilds(userGuilds, botGuildIds);
        } catch (e) {
          loadingGuilds.style.display = "none";
          guildError.textContent = "Failed to load guilds. Please refresh or log out and log back in.";
          guildError.classList.remove("hidden");
          console.error(e);
          logout();
        }
      }
    };

    // Event listeners
    logoutBtn.onclick = logout;

    modUserIdInput.addEventListener("input", updateButtonsState);

    slurFilterToggle.addEventListener("change", () => {
      if (!currentGuild) return;
      fetch(`${apiBase}/${currentGuild.id}/settings`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ racialFilter: slurFilterToggle.checked }),
      }).catch(console.error);
    });

    addBtn.onclick = () => {
      if (!currentGuild) return;
      const id = modUserIdInput.value.trim();
      if (!id) return alert("Please enter a User ID.");
      if (!moderators.includes(id)) moderators.push(id);

      fetch(`${apiBase}/${currentGuild.id}/moderators`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(moderators),
      })
        .then(() => loadGuildDashboard(currentGuild))
        .catch(console.error);
    };

    removeBtn.onclick = () => {
      if (!currentGuild) return;
      const id = modUserIdInput.value.trim();
      if (!id) return alert("Please enter a User ID.");
      const idx = moderators.indexOf(id);
      if (idx > -1) moderators.splice(idx, 1);

      fetch(`${apiBase}/${currentGuild.id}/moderators`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(moderators),
      })
        .then(() => loadGuildDashboard(currentGuild))
        .catch(console.error);
    };
  </script>
</body>
</html>
